<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>用户签到 - 续费计划</title>
    <meta name="description" content="用户签到续费页面" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="images/default.png" />

    <!-- Tailwind CSS -->
    <script src="./tailwindcss.js"></script>

    <script>
      const currentDomain = window.location.hostname;

      // Check the domain and conditionally add the script
      if (
        currentDomain === 'end-gfw.com' ||
        currentDomain === 'vpn.ban-gfw.com'
      ) {
        const script = document.createElement('script');
        script.src =
          'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7165471280882308'; // Replace with your script URL
        script.type = 'text/javascript';
        script.async = true;
        script.crossorigin = 'anonymous';

        // Append the script to the document head or body
        document.head.appendChild(script);
      }
    </script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: '#eff6ff',
                100: '#dbeafe',
                500: '#3b82f6',
                600: '#2563eb',
                700: '#1d4ed8',
              },
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-in-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
            },
          },
        },
      };
    </script>
  </head>
  
  <body class="bg-gray-50 min-h-screen">
    <main class="container mx-auto px-4 py-20">
      <div class="max-w-2xl mx-auto">
        <!-- Check-in Section -->
        <section class="bg-white rounded-xl shadow-lg p-6 animate-fade-in">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">用户签到</h2>
          
          <div class="flex flex-col sm:flex-row gap-3">
            <div class="flex-1">
              <input
                type="text"
                name="token"
                id="token"
                placeholder="输入您的Email邮箱地址"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
              />
            </div>
            <button
              type="submit"
              id="renew-button"
              onclick="renewPlan()"
              disabled
              class="px-6 py-3 bg-primary-600 text-white rounded-lg font-semibold hover:bg-primary-700 focus:ring-2 focus:ring-primary-500 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed disabled:hover:bg-gray-400"
            >
              签到
            </button>
          </div>
          
          <span id="token-status" class="mt-3 hidden text-sm block"></span>
        </section>

        <!-- Instructions Section -->
        <section class="bg-blue-50 rounded-xl shadow p-6 mt-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-3">使用说明</h3>
          <ul class="space-y-2 text-gray-700">
            <li>• 3天后需要重新签到,未签到将被屏蔽</li>
            <li>• 7天后解除屏蔽</li>
          </ul>
        </section>
      </div>
    </main>

    <!-- Notification for status messages -->
    <div
      id="notification"
      class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-full transition-transform hidden z-50"
    >
      <span id="notification-text">操作成功！</span>
    </div>

    <script>
      async function renewPlan() {
        const tokenElement = document.getElementById('token');
        const tokenStatusElement = document.getElementById('token-status');

        const token = tokenElement.value.trim();

        console.log('token: ', token);

        if (!token) {
          showNotification('请输入您的Email邮箱地址', 'error');
          return;
        }

        tokenStatusElement.classList.remove('hidden');
        tokenStatusElement.classList.remove('text-green-600', 'text-red-600');
        tokenStatusElement.classList.add('text-blue-600');
        tokenStatusElement.textContent = '签到中...';

        try {
          const response = await fetch(`/renew-email?email=${token}`);
          
          if (response.ok) {
            tokenStatusElement.classList.remove('text-blue-600');
            tokenStatusElement.classList.add('text-green-600');
            tokenStatusElement.textContent = '签到成功!';
            showNotification('签到成功！', 'success');
          } else {
            throw new Error('签到失败');
          }
        } catch (err) {
          tokenStatusElement.classList.remove('text-blue-600');
          tokenStatusElement.classList.add('text-red-600');
          tokenStatusElement.textContent = '签到失败!';
          showNotification('签到失败，请稍后重试', 'error');
          console.error('error token renew', token, err);
        }
      }

      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        
        notificationText.textContent = message;
        
        // Set color based on type
        notification.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500');
        if (type === 'error') {
          notification.classList.add('bg-red-500');
        } else if (type === 'info') {
          notification.classList.add('bg-blue-500');
        } else {
          notification.classList.add('bg-green-500');
        }
        
        notification.classList.remove('hidden', 'translate-y-full');
        notification.classList.add('translate-y-0');

        setTimeout(() => {
          notification.classList.remove('translate-y-0');
          notification.classList.add('translate-y-full');
          setTimeout(() => {
            notification.classList.add('hidden');
          }, 300);
        }, 3000);
      }

      // Check domain and enable/disable button
      function checkDomainAndEnableButton() {
        const currentDomain = window.location.hostname;
        const renewButton = document.getElementById('renew-button');
        
        if (currentDomain.includes('end-gfw.com') || currentDomain.includes('localhost')) {
          renewButton.disabled = false;
        } else {
          renewButton.disabled = true;
          showNotification('此功能仅在 end-gfw.com 域名下可用', 'info');
        }
      }

      // Run on page load
      document.addEventListener('DOMContentLoaded', checkDomainAndEnableButton);

      // Allow Enter key to submit
      document.getElementById('token').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          const renewButton = document.getElementById('renew-button');
          if (!renewButton.disabled) {
            renewPlan();
          }
        }
      });
    </script>
  </body>
</html>
